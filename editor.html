<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Éditeur - Post Match Generator</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Jersey+25&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/editor.css">
</head>

<body>

<a href="selection.html" class="btn-back fixed">← Retour</a>
<a href="index.html" class="btn-profile fixed" title="Connectez-vous pour accéder à votre profil">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
    <circle cx="12" cy="7" r="4"/>
  </svg>
  Profil
</a>

<h1 class="main-title">Éditeur d'affiche</h1>

<div class="layout">

  <!-- ===== VISUEL (Fixed) ===== -->
  <div class="visual-container">
    <div class="base" id="capture">
      <img id="bgImage" class="bg-image">

      <div class="info info1" id="info1">LIGUE 1</div>
      <div class="info AvsB" id="matchTitle">Équipe A - Équipe B</div>
      <div class="info info2" id="info2">JOURNÉE 13</div>

      <div class="rouge"></div>
      <div class="texte">FULLTIME</div>

      <div class="degrader"></div>
      <div class="vertA" id="logoA"></div>
      <div class="vertB" id="logoB"></div>
      <div class="scoreA" id="displayScoreA">0</div>
      <div class="trait">-</div>
      <div class="scoreB" id="displayScoreB">0</div>

    </div>
  </div>

  <!-- ===== CONTROLS (Scrollable) ===== -->
  <div class="controls">

    <!-- Équipes -->
    <div class="control-block">
      <div class="control-title">Équipe A</div>
      <div class="team-display-v1" id="teamA-display">
        <div class="team-logo-preview empty-logo" id="teamA-logo"></div>
        <div class="team-info">
          <div class="team-name" id="teamA-name">Aucune équipe</div>
          <button id="teamA-btn">Choisir</button>
        </div>
      </div>
    </div>

    <div class="control-block">
      <div class="control-title">Équipe B</div>
      <div class="team-display-v1" id="teamB-display">
        <div class="team-logo-preview empty-logo" id="teamB-logo"></div>
        <div class="team-info">
          <div class="team-name" id="teamB-name">Aucune équipe</div>
          <button id="teamB-btn">Choisir</button>
        </div>
      </div>
    </div>

    <!-- MODAL SÉLECTION ÉQUIPE -->
    <div class="modal" id="clubModal">
      <div class="modal-content">
        <button class="modal-close-x" id="closeModalX">×</button>

        <!-- Vue recherche -->
        <div id="searchView">
          <div class="modal-title">Choisir une équipe</div>
          <input type="text" class="club-search" id="clubSearchModal" placeholder="Rechercher une équipe...">
          <div class="club-list" id="clubListModal"></div>
          <button class="btn-add-club" id="btnShowAddClub">+ Ajouter un nouveau club</button>
        </div>

        <!-- Vue ajout club -->
        <div id="addClubView" class="hidden">
          <div class="modal-title">Ajouter un club</div>
          <div class="add-club-form">
            <div class="form-group">
              <label>Nom du club</label>
              <input type="text" id="newClubName" placeholder="Ex: Real Madrid">
            </div>
            <div class="form-group">
              <label>Abréviation</label>
              <input type="text" id="newClubAbbr" placeholder="Ex: RMA" maxlength="5">
            </div>
            <div class="form-group">
              <label>Logo du club</label>
              <div class="logo-upload-mini">
                <div class="logo-preview-mini" id="newClubLogoPreview">
                  <span>+</span>
                </div>
                <input type="file" id="newClubLogoInput" accept="image/*" hidden>
                <button class="btn-upload-mini" id="btnUploadNewLogo">Choisir</button>
              </div>
            </div>
            <div class="form-actions-modal">
              <button class="btn-cancel-modal" id="btnCancelAddClub">Annuler</button>
              <button class="btn-save-modal" id="btnSaveNewClub">Ajouter</button>
            </div>
          </div>
        </div>

        <button class="modal-close" id="closeModal">Fermer</button>
      </div>
    </div>

    <!-- Scores -->
    <div class="control-block">
      <div class="control-title">Score Équipe A</div>
      <input
        type="number"
        id="inputScoreA"
        min="0"
        max="9"
        value="0"
      >
    </div>

    <div class="control-block">
      <div class="control-title">Score Équipe B</div>
      <input
        type="number"
        id="inputScoreB"
        min="0"
        max="9"
        value="0"
      >
    </div>

    <!-- Info droite -->
    <div class="control-block">
      <div class="control-title">Info droite</div>
      <input
        type="text"
        id="inputInfo2"
        placeholder="Ex: JOURNÉE 13"
        value="JOURNÉE 13"
      >
    </div>

    <!-- Compétition -->
    <div class="control-block">
      <div class="control-title">Compétition</div>
      <div class="button-group">
        <button class="active" data-competition="LIGUE 1">Ligue 1</button>
        <button data-competition="NATIONAL 3">National 3</button>
      </div>
    </div>

    <!-- Inverser les équipes -->
    <div class="control-block">
      <div class="control-title">Actions rapides</div>
      <button id="btnSwapTeams" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); width: 100%;">
        ⇄ Inverser les équipes
      </button>
    </div>

    <!-- Couleur du dégradé -->
    <div class="control-block">
      <div class="control-title">Couleur du dégradé</div>
      <div class="color-picker-wrapper">
        <input type="color" id="gradientColorPicker" value="#05118f">
        <label for="gradientColorPicker" class="color-picker-label">Choisir une couleur</label>
      </div>
    </div>

    <!-- Image -->
    <div class="control-block">
      <div class="control-title">Importer image de fond</div>
      <input type="file" id="fileInput" accept="image/*,.jpg,.jpeg,.png,.gif,.webp">
    </div>

    <!-- NOUVEAU : Bouton Recadrer -->
    <div class="control-block">
      <button id="btnRecadrer" disabled style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        Recadrer l'image
      </button>
    </div>

    <!-- Ancien Zoom (caché par défaut, optionnel) -->
    <div class="control-block hidden">
      <button id="btnZoom">Zoom image</button>

      <div id="zoomControls" class="hidden">
        <input
          type="range"
          id="zoomSlider"
          min="1"
          max="1.5"
          step="0.01"
          value="1"
        >
        <button id="btnCloseZoom">Fermer le zoom</button>
      </div>
    </div>

    <!-- Export -->
    <div class="control-block">
      <div class="button-group">
        <button id="btnExport" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); font-size: 15px; padding: 14px;">
          Exporter
        </button>
        <button id="btnShare" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 15px; padding: 14px;">
          Partager
        </button>
      </div>
    </div>

  </div>

</div>

<!-- MODAL RECADRAGE -->
<div class="recadrage-modal" id="recadrageModal">
  <div class="recadrage-container">
    
    <div class="recadrage-header">
      <h2>Recadrer l'image</h2>
      <p>1 doigt pour déplacer • 2 doigts pour zoomer</p>
    </div>

    <!-- PREVIEW COMPLET AVEC TOUS LES ÉLÉMENTS -->
    <div class="recadrage-preview" id="recadragePreview">
      <img id="recadrageImage" class="recadrage-image">

      <!-- TOUS LES ÉLÉMENTS VISUELS -->
      <div class="info info1" id="recadrage-info1">LIGUE 1</div>
      <div class="info AvsB" id="recadrage-matchTitle">Équipe A - Équipe B</div>
      <div class="info info2" id="recadrage-info2">JOURNÉE 13</div>

      <div class="rouge"></div>
      <div class="texte">FULLTIME</div>

      <div class="degrader"></div>
      <div class="vertA" id="recadrage-logoA"></div>
      <div class="vertB" id="recadrage-logoB"></div>
      <div class="scoreA" id="recadrage-displayScoreA">0</div>
      <div class="trait">-</div>
      <div class="scoreB" id="recadrage-displayScoreB">0</div>

      <div class="recadrage-grid"></div>
    </div>

    <div class="recadrage-controls">
      <div class="zoom-control">
        <label>Zoom</label>
        <input 
          type="range" 
          id="recadrageZoomSlider" 
          min="1" 
          max="3" 
          step="0.01" 
          value="1"
        >
      </div>

      <div class="recadrage-actions">
        <button id="btnAnnulerRecadrage">Annuler</button>
        <button id="btnValiderRecadrage">Valider</button>
      </div>
    </div>

  </div>
</div>

<!-- JavaScript -->
<script src="js/supabase-config.js"></script>
<script src="js/auth.js"></script>
<script src="js/clubs.js"></script>
<script src="js/clubs-supabase.js"></script>
<script src="js/editor.js"></script>
<script>
  // Gestion du profil utilisateur dans l'éditeur
  const btnProfile = document.querySelector('.btn-profile');

  (async () => {
    const session = await getSession();

    if (session) {
      // Utilisateur connecté
      const user = session.user;
      const nomUtilisateur = user.user_metadata?.nom_utilisateur || user.email.split('@')[0];

      btnProfile.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        ${nomUtilisateur}
      `;
      btnProfile.href = 'profile.html';
      btnProfile.title = 'Voir mon profil';
    } else if (estModeInvite()) {
      // Mode invité
      btnProfile.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        Invité
      `;
      btnProfile.href = 'index.html';
      btnProfile.title = 'Connectez-vous pour accéder à votre profil';
    } else {
      // Pas connecté et pas en mode invité - rediriger
      window.location.href = 'index.html';
    }
  })();
</script>

</body>
</html>
